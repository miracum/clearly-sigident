---
title: "sigident - Howto SVM-KNN-RF"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sigident-Howto_SVM-KNN-RF}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The R package `sigident` is the core package of the `sigident` package framework. This framework consists of several packages which can be used to perform analyses of gene signatures. The following packages are included in the framework: 
* Core package: [sigident](https://gitlab.miracum.org/clearly/sigident) 
* Data preprocessing: [sigident.preproc](https://gitlab.miracum.org/clearly/sigident.preproc) 
* Functional analyses: [sigident.func](https://gitlab.miracum.org/clearly/sigident.func)  

# Prerequisites and installation 

## Install sigident.preproc package

```{r eval = FALSE}
options('repos' = 'https://ftp.fau.de/cran/')
install.packages("devtools")
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.preproc.git",
                      upgrade = "always")
```

## Install sigident.func package

```{r eval = FALSE}
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.func.git",
                      upgrade = "always")
```

## Install sigident package

```{r eval = FALSE}
devtools::install_git("https://gitlab.miracum.org/clearly/sigident.git")
```

# Preprocessing 

In order to use this R package and its functions, you need to prepare a merged gene expression dataset. The workflow to achieve this is presented in the following by making use of the R package `sigident.preproc`.

For a more detailed background and description of the following steps please view the `sigident.preproc` package's [vignette](https://gitlab.miracum.org/clearly/sigident_vignettes).

## Initialization of important variables

```{r setup}
library(sigident)
library(sigident.preproc)
library(sigident.func)
library(knitr)
library(caret)

# initialize filePath:
filePath <- tempdir()

# define datadir
maindir <- "./geodata/"
datadir <- paste0(maindir, "data/")
dir.create(maindir)
dir.create(datadir)

# define plotdir
plotdir <- "./plots/"
dir.create(plotdir)

# define idtype
idtype = "affy"
```

## Define list that contains a representation of the studies metadata

```{r}
studiesinfo <- list(
  "GSE18842" = list(
    setid = 1,
    targetcolname = "source_name_ch1",
    targetlevelname = "Human Lung Tumor",
    controllevelname = "Human Lung Control"
    ),
  
  "GSE19804" = list(
    setid = 1,
    targetcolname = "source_name_ch1",
    targetlevelname = "frozen tissue of primary tumor",
    controllevelname = "frozen tissue of adjacent normal"
  ),
  
  "GSE19188" = list(
    setid = 1,
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue type: healthy",
    targetlevelname = "tissue type: tumor",
    use_rawdata = TRUE
  )
)
```

## Load GEO datasets

All downloaded datasets will be assigned to the global environment.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
sigident.preproc::load_geo_data(
  studiesinfo = studiesinfo,
  datadir = datadir,
  plotdir = plotdir,
  idtype = idtype,
  viz_batch_boxp = F,
  viz_batch_gpca = F
) 
```

### Visualize batch effect

By using the argument `viz_batch_boxp = TRUE` and `viz_batch_gpca = TRUE`, one can visualize batch effects before and after correction with two methods: boxplots and gPCA and store them in the directory specified in `plotdir`. For further details please view the package vignette of the `sigident.preproc` R package. 
Due to the ressource intensive calculations of the plots, this argument is set to FALSE here. 

# Preparations for utilizing the sigident package 

Before using the `sigident` package, these variables need to be defined properly. One could use them also as arguments directly in the respective function. However, to keep the code clearer we define them here at the beginning and refer at each function to the respective variable. 
`idtype` and `plotdir` have already been defined during the preprocessing steps.

In order to use this R package and its functions, you need to prepare a merged gene expression dataset. The workflow to achieve this is presented in the following by making use of the R package `sigident.preproc`.

For a detailed background on the following steps please view the `sigident.preproc` package's [vignette](https://gitlab.miracum.org/clearly/sigident_vignettes).

```{r}
# general
csvdir <- "./csv/"
dir.create(csvdir)

# enrichment analysis
species <- "Hs"
OrgDb <- "org.Hs.eg.db"
organism <- "hsa"
#pathwayid <- "hsa04110" # Cell Cycle
pathwayid <- "hsa04151" # PI3K-Akt

# diagnostic signature
seed <- 111
split <- 0.8
nfolds <- 10
```

# DEG analysis 

For a detailed background and description of the following steps please view the `sigident.func` package's vignette.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# define the false discovery rate here
fdr <- 0.05

genes <- sigident.func::identify_degs(mergeset = mergeset,
                                      diagnosis = diagnosis,
                                      q_value = fdr)

# heatmap creation
filename <- paste0(plotdir, "DEG_heatmap.png")
# create colors for map
ht_colors <- sigident.func::color_heatmap(sample_metadata = sample_metadata)
sigident.func::plot_deg_heatmap(mergeset = mergeset,
                                genes = genes,
                                patientcolors = ht_colors,
                                filename = filename)
```

```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r}
deg_info <- sigident.func::export_deg_annotations(mergedset = mergedset,
                                                  genes = genes,
                                                  idtype = idtype)
data.table::fwrite(deg_info, paste0(csvdir, "DEG_info.csv"))
```

```{r}
dim(deg_info)
knitr::kable(head(deg_info))
```

```{r}
deg_results <- sigident.func::limma_top_table(mergeset = mergeset,
                                              diagnosis = diagnosis,
                                              q_value = fdr)
data.table::fwrite(deg_results, paste0(csvdir, "DEG_results.csv"))
```

```{r}
dim(deg_results)
knitr::kable(head(deg_results))
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(deg_info, deg_results, studiesinfo)
gc()
```


<!-- # Functional analysis -->

<!-- ## Gene enrichment -->

<!-- For a detailed background and description of the following steps please view the `sigident.func` package's [vignette](https://gitlab.miracum.org/clearly/sigident_vignettes). -->

<!-- ```{r} -->
<!-- deg_entrez <- unique(mergedset@featureData@data$ENTREZ_GENE_ID) -->
<!-- deg_entrez <- deg_entrez[deg_entrez != ""] -->
<!-- ``` -->

<!-- ## Test for over-representation  -->

<!-- ```{r} -->
<!-- enr_topgo <- sigident.func::extract_go_terms(gene = deg_entrez, -->
<!--                                              species = species) -->
<!-- data.table::fwrite(enr_topgo, paste0(csvdir, "Top_GO.csv")) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- dim(enr_topgo) -->
<!-- knitr::kable(head(enr_topgo)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- enr_topkegg <- sigident.func::extract_kegg_terms(gene = deg_entrez, -->
<!--                                                  species = species) -->
<!-- data.table::fwrite(enr_topkegg, paste0(csvdir, "Top_KEGG.csv")) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- dim(enr_topkegg) -->
<!-- knitr::kable(head(enr_topkegg)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- enr_fitlm <- sigident.func::go_diff_reg( -->
<!--   mergeset = mergeset, -->
<!--   idtype = idtype, -->
<!--   diagnosis = diagnosis, -->
<!--   entrezids = mergedset@featureData@data$ENTREZ_GENE_ID -->
<!-- ) -->

<!-- enr_fitlm_topgo <- sigident.func::extract_go_terms( -->
<!--   gene = enr_fitlm, -->
<!--   species = species, -->
<!--   fdr = 0.01 -->
<!-- ) -->
<!-- data.table::fwrite(enr_fitlm_topgo, paste0(csvdir, "Top_GO_fitlm.csv")) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- dim(enr_fitlm_topgo) -->
<!-- knitr::kable(head(enr_fitlm_topgo)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- enr_fitlm_topkegg <- sigident.func::extract_kegg_terms( -->
<!--   gene = enr_fitlm, -->
<!--   species = species -->
<!-- ) -->
<!-- data.table::fwrite(enr_fitlm_topkegg, paste0(csvdir, "Top_KEGG_fitlm.csv")) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- dim(enr_fitlm_topkegg) -->
<!-- knitr::kable(head(enr_fitlm_topkegg)) -->
<!-- ``` -->

<!-- ## GO enrichment analysis -->

<!-- ```{r results='hide', message=FALSE, warning=FALSE, error=FALSE} -->
<!-- enr_analysis <- sigident.func::go_enrichment_analysis( -->
<!--   gene = deg_entrez, -->
<!--   org_db = OrgDb, -->
<!--   organism = organism, -->
<!--   fitlm = enr_fitlm, -->
<!--   pathwayid = pathwayid, -->
<!--   species = organism, -->
<!--   plotdir = plotdir -->
<!-- ) -->
<!-- ``` -->
<!-- ```{r results='hide', message=FALSE, warning=FALSE, error=FALSE} -->
<!-- filename <- paste0(plotdir, "/", pathwayid, ".png") -->
<!-- ``` -->
<!-- ```{r out.width='80%'} -->
<!-- knitr::include_graphics(filename) -->
<!-- ``` -->
<!-- ```{r results='hide', message=FALSE, warning=FALSE, error=FALSE} -->
<!-- filename <- paste0(plotdir, "/", pathwayid, ".pathview.png") -->
<!-- ``` -->
<!-- ```{r out.width='80%'} -->
<!-- knitr::include_graphics(filename) -->
<!-- ``` -->

<!-- ```{r results='hide', message=FALSE, warning=FALSE, error=FALSE} -->
<!-- filename <- paste0(plotdir, "Enriched_GO.png") -->
<!-- sigident.func::plot_enriched_barplot( -->
<!--   enrichmentobj = enr_analysis$go, -->
<!--   type = "GO", -->
<!--   filename = filename -->
<!-- ) -->
<!-- ``` -->
<!-- ```{r out.width='80%'} -->
<!-- knitr::include_graphics(filename) -->
<!-- ``` -->

<!-- ```{r results='hide', message=FALSE, warning=FALSE, error=FALSE} -->
<!-- filename <- paste0(plotdir, "Enriched_KEGG.png") -->
<!-- sigident.func::plot_enriched_barplot( -->
<!--   enrichmentobj = enr_analysis$kegg, -->
<!--   type = "KEGG", -->
<!--   filename = filename -->
<!-- ) -->
<!-- ``` -->
<!-- ```{r out.width='80%'} -->
<!-- knitr::include_graphics(filename) -->
<!-- ``` -->

<!-- ```{r results='hide', message=FALSE, warning=FALSE, error=FALSE} -->
<!-- rm(bods, enr_analysis, enr_fitlm, enr_fitlm_topgo, enr_fitlm_topkegg, -->
<!--    enr_topgo, enr_topkegg, gene.idtype.bods, korg, cpd.simtypes, -->
<!--    deg_entrez, gene.idtype.list, ht_colors, mergedset) -->
<!-- gc() -->
<!-- ``` -->

# Identification of diagnostic signatures 

A common task regarding gene expression data is to distinguish between different groups or subtypes. In order to train a multi-gene classifier, a large amount of expression data is required. Due to the imbalance of features (p) versus observations (n), the application of an appropriate method is needed.

## Split data into training and test dataset

A statistical prediction model is usually trained on 70%-80% percent of the present data. `create_training_test_split` randomly splits the merged dataset into a training and a test set with the former defined value `split` regarding to a balanced distribution of the groups (here diagnosis). For reproducibility, a seed must be set.  

```{r}
training_list <- sigident::create_training_test_split(
  diagnosis = diagnosis,
  mergeset = mergeset,
  split = split,
  seed = seed
)
```

## SVM 

A support vector machine is a collection of supervised learning algorithms that use hyperplane graphing to analyze new, unlabeled data. In Support Vector Machine incoming data is categorized into one of two classes. For SVM models, each data point is interpreted as a p-dimensional vector, which the machine attempts to create a linear classifier by fitting the data point inside a hyperplane (p-1 dimension). 
So for classification, every input is turned into a point in n-dimensional space (n being the number of features), and the value of each feature defined as the value of a unique coordinate on the hyperplane. Classification is determined by finding the hyperplane that most clearly separates the two classes. 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_svm <- sigident::signature(
  traininglist = training_list,
  type = "svm",
  nfolds = nfolds,
  seed = seed
)
filename <- paste0(plotdir, "CV_SVM.png")
sigident::plot_cvplot(cv_obj = diagnostic_svm$model,
                      filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_SVM.png")
sigident::plot_rocplot(roc = diagnostic_svm$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

## k-nearest neighbors regression 

The k-nearest neighbors algorithm, or kNN, is one of the simplest machine learning algorithms. Usually, k is a small, odd number - sometimes only 1. The larger k is, the more accurate the classification will be, but the longer it takes to perform the classification. It classifies an object into one of several classes by looking at the k elements of the training set that are closest to the one you want to classify, and letting them vote by majority on what that objectâ€™s class should be.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_knn <- sigident::signature(
  traininglist = training_list,
  type = "knn",
  nfolds = nfolds,
  seed = seed
)
filename <- paste0(plotdir, "CV_KNN.png")
sigident::plot_cvplot(cv_obj = diagnostic_knn$model,
                      filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_KNN.png")
sigident::plot_rocplot(roc = diagnostic_knn$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

## random forest regression 

The random forest regression is a supervised learning algorithm that randomly creates and merges multiple decision trees into one forest. The goal is not to rely on a single learning model, but rather a collection of decision models to improve accuracy. The primary difference between this approach and the standard decision tree algorithms is that the root nodes feature splitting nodes are generated randomly.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
diagnostic_rf <- sigident::signature(
  traininglist = training_list,
  type = "random_forest",
  nfolds = nfolds,
  seed = seed
)
filename <- paste0(plotdir, "CV_RF.png")
sigident::plot_cvplot(cv_obj = diagnostic_rf$model,
                      filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
filename <- paste0(plotdir, "ROC_RF.png")
sigident::plot_rocplot(roc = diagnostic_rf$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

## Analysis of diagnostic models 

### Comparing model performance  

These models can be included into a list and the performance metrices for classification can then be printed using the function `compare_diagnostic_models()`. This list includes all information of the respective models, which can be accessed by the following structure.  

```{r}
diagnostic_models <- list(
  "svm" = list("model" = diagnostic_svm$model,
                 "confmat" = diagnostic_svm$confusion_matrix,
                 "prediction" = diagnostic_svm$prediction,
                 "auc" = as.numeric(diagnostic_svm$roc$auc)
                 
  ),
  "knn" = list("model" = diagnostic_knn$model,
                 "confmat" = diagnostic_knn$confusion_matrix,
                 "prediction" = diagnostic_knn$prediction,
                 "auc" = as.numeric(diagnostic_knn$roc$auc)
                 
  ),
  "rf" = list("model" = diagnostic_rf$model,
                 "confmat" = diagnostic_rf$confusion_matrix,
                 "prediction" = diagnostic_rf$prediction,
                 "auc" = as.numeric(diagnostic_rf$roc$auc)
                 
  )
)
```

```{r}
knitr::kable(
  sigident::compare_diagnostic_models(diagnostic_models)
)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(diagnostic_svm, diagnostic_knn, diagnostic_rf,
   training_list)
gc()
```

### Model performance measurements

Additionally, the confusion matrix and the calculated performance metrics can be printed out for each model. 

#### SVM

```{r}
diagnostic_models$svm$confmat
```

#### KNN

```{r}
diagnostic_models$knn$confmat
```

#### RF

```{r}
diagnostic_models$rf$confmat
```

### Export selected IDs for each model 

The following function enables the extraction of the selected genes (Affy-IDs) for each model as csv file.

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$svm$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_svm.csv"))
```

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$knn$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_knn.csv"))
```

```{r}
signaturegenes <- sigident::gene_map_sig(
  mergeset = mergeset,
  model = diagnostic_models$rf$model
)
data.table::fwrite(signaturegenes,
                   paste0(csvdir, "signaturegenes_rf.csv"))
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
rm(signaturegenes)
gc()
```

## Validation of diagnostic signatures 

The validation of diagnostic signatures is conducted using the independent expression datasets of the studies "GSE30219", "GSE33356" and "GSE102287". We therefore need to create a list, holding meta information about the respective studies. 

You have to create a list that contains specifications of the validation studeis. The object must be named. The list structure is as follows:  
* `studyname`: the GEO id of the validation study  
  + `setid`: the index of the provided GEO set to be used    
  + `targetcolname`: the name of the phenoData column containing the target-variable  
  + `controllevelname`: the level name of the controls of the column, specified in `targetcolname`  
  + `targetlevelname`: the level name of the subjects of interest in `targetcolname` 


```{r}
validationstudylist <- list(
  "GSE30219" = list(
    setid = 1, 
    targetcolname = "source_name_ch1",
    controllevelname = "Non Tumoral Lung",
    targetlevelname = "Lung Tumour"
  ),
  "GSE33356" = list(
    setid = 1, 
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue: paired normal adjacent",
    targetlevelname = "tissue: lung cancer"
  ),
  "GSE102287" = list(
    setid = 2, 
    targetcolname = "characteristics_ch1.6",
    controllevelname = "tumor_normal status: N",
    targetlevelname = "tumor_normal status: T"
  )
)
```

All models can be provided via the argument 'model' to the function `sigident::validate_diagnostic_signatures` using the previously created list `diagnostic_models`.

To perform the validation of the diagnostic signatures, simply run the function `sigident::validate_diagnostic_signatures` with the specified `validationstudylist`.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
validation_results <- sigident::validate_diagnostic_signatures(
  validationstudylist = validationstudylist,
  models = diagnostic_models,
  genes = genes,
  idtype = idtype,
  datadir = datadir
)
```

### GSE302019 

#### SVM

```{r}
validation_results[["GSE30219"]]$svm$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_svm.png")
sigident::plot_rocplot(roc = validation_results[["GSE30219"]]$svm$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN 

```{r}
validation_results[["GSE30219"]]$knn$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_knn.png")
sigident::plot_rocplot(roc = validation_results[["GSE30219"]]$knn$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN 

```{r}
validation_results[["GSE30219"]]$rf$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE30219_rf.png")
sigident::plot_rocplot(roc = validation_results[["GSE30219"]]$rf$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
validation_results[["GSE30219"]] <- NULL
gc()
```

### GSE33356 

#### SVM

```{r}
validation_results[["GSE33356"]]$svm$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_svm.png")
sigident::plot_rocplot(roc = validation_results[["GSE33356"]]$svm$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN

```{r}
validation_results[["GSE33356"]]$knn$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_knn.png")
sigident::plot_rocplot(roc = validation_results[["GSE33356"]]$knn$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF

```{r}
validation_results[["GSE33356"]]$rf$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE33356_rf.png")
sigident::plot_rocplot(roc = validation_results[["GSE33356"]]$rf$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
validation_results[["GSE33356"]] <- NULL
gc()
```

### GSE102287 

#### SVM

```{r}
validation_results[["GSE102287"]]$svm$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_svm.png")
sigident::plot_rocplot(roc = validation_results[["GSE102287"]]$svm$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### KNN 

```{r}
validation_results[["GSE102287"]]$knn$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_knn.png")
sigident::plot_rocplot(roc = validation_results[["GSE102287"]]$knn$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

#### RF 

```{r}
validation_results[["GSE102287"]]$rf$confmat
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "ROC_validation_GSE102287_rf.png")
sigident::plot_rocplot(roc = validation_results[["GSE102287"]]$rf$roc,
                       filename = filename)
```
```{r out.width='80%'}
knitr::include_graphics(filename)
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
validation_results[["GSE102287"]] <- NULL
rm(validationstudylist, diagnostic_models, GSE102287, GSE33356)
gc()
```

# Identification of prognostic signatures 

## Create a list that contains specifications of the study/studies that contain(s) survival time information 

For the calculation of a prognostic signature it is first required to transform the phenoData containing the relevant survival data. In our example, only the study GSE19188 contains information on a subjects survival.  
In order to make the subsequent analyses possible, the list `discoverystudies_w_timedata`, containing metainformation about the validation study needs to be created. This nested list needs to contain the following elements:  
* the studyname, which is the key for a list containing  
  + `setid`: the index of the provided GEO set to be used   
  + `timecol`: the phenoData columm name of the survival time  
  + `status`: a list, containing the elements `statuscol` (name of phenoData column containing the survival status), `levels` (a list containing the originally used level-names of `statuscol`, namely `alive`, `deceased`, `na`)  
  + `targetcolname`: the name of the phenoData column containing the target-variable  
  + `controllevelname`: the level name of the controls of the column, specified in `targetcolname`  
  + `targetlevelname`: the level name of the subjects of interest in `targetcolname`  
  + `use_rawdata`: a logical value (TRUE or FALSE) that indicates, if the study is imported from the raw data  
  
Since we already used the raw data above to load the study 'GSE19188' for the analyses of the DEGs, the enrichment analysis and the computation of the diagnostic signature, we here again import the study from the raw CEL files.  

```{r eval = TRUE}
discoverystudies_w_timedata <- list(
  "GSE19188" = list(
    setid = 1,
    timecol = "characteristics_ch1.2",
    status = list(
      statuscol = "characteristics_ch1.3",
      levels = list(alive = "status: alive",
                    deceased = "status: deceased",
                    na = "status: Not available")),
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue type: healthy",
    targetlevelname = "tissue type: tumor",
    use_rawdata = TRUE)
)
```


## Identification of survival correlated genes 

### Extract survival data 

Next, the survival data needs to be extracted. `get_survival_time` results in a table named `survival_data`, containing samples (in our example of the class tumor) as rows, survival time and if an event (death) happened as columns. Additionally, the expression values of the selected DEGs (provided as parameter 'genes') are added as columns to the table. 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}

### Identification of survival correlated genes
survival_data <- sigident::get_survival_time(
  sample_metadata = sample_metadata,
  genes = genes,
  idtype = idtype,
  discoverystudies_w_timedata = discoverystudies_w_timedata,
  datadir = datadir
)
survival_table <- survival_data[["GSE19188"]]
```

```{r}
dim(survival_table)
head(survival_table[,1:4])
```

### Compute univariate cox regression 

Subsequently, an univariate Cox regression is conducted to identify survival correlated genes. The results containing the hazard rate within a 95% CI and corresponding p-values are exported as csv-file. 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
surv_correlated <- sigident::univ_cox(survtable = survival_table,
                                      genes = genes)
# export table with survival correlated genes
data.table::fwrite(surv_correlated,
                   paste0(csvdir, "survival_correlated_genes.csv"))
```

```{r}
dim(surv_correlated)
head(surv_correlated)
```

## Prognostic classifier and Kaplan-Meier estimator

In order to build an unbiased classifier that speparates subjects into high risk and low risk groups, expression data from the remaining discovery studies are required. 

### Evaluate expression pattern (over-/underrepresentation)

The classifier takes the expression profiles of the identified survival correlated genes between tumor and non-tumor samples into account. 

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
classifier_studies <- c("GSE18842", "GSE19804")
expr_pattern <- sigident::generate_expression_pattern(
  classifier_studies = classifier_studies,
  sig_cov = surv_correlated,
  mergeset = mergeset,
  sample_metadata = sample_metadata
)
```

```{r}
dim(expr_pattern)
head(expr_pattern)
```

### Apply the prognostic classifier on validation dataset 

In order to apply the prognostic classifier on validation datasets, another list containing metainformation about these validation studies is required. This list (`validationstudiesinfo`) has the same structure as the above described list `discoverystudies_w_timedata`.  
However, the element `use_rawdata` is not allowed here. Furthermore, is allowed to to set `targetlevelname` to 'NULL', which indicates, that all included samples are of the class of interest and are taken into account to perform the analyses.  

#### Create a list that contains specifications of the study that contains the validation information

```{r eval = TRUE}
validationstudiesinfo <- list(
  "GSE30219" = list(
    setid = 1,
    timecol = "characteristics_ch1.9",
    status = list(
      statuscol = "characteristics_ch1.8",
      levels = list(alive = "status: ALIVE",
                    deceased = "status: DEAD",
                    na = "status: NTL")
    ),
    targetcolname = "source_name_ch1",
    controllevelname = "Non Tumoral Lung",
    targetlevelname = "Lung Tumour"),
  
  "GSE50081" = list(
    setid = 1,
    timecol = "characteristics_ch1.8",
    status = list(
      statuscol = "characteristics_ch1.9",
      levels = list(
        alive = "status: alive",
        deceased = "status: dead",
        na = NA)
    ),
    targetcolname = "characteristics_ch1.1",
    targetlevelname = paste(
      "histology: adenocarcinoma",
      "histology: adenosquamous carcinoma",
      "histology: large cell carcinoma",
      "histology: NSClarge cell carcinoma-mixed",
      "histology: NSCLC-favor adenocarcinoma",
      "histology: squamous cell carcinoma",
      "histology: squamous cell carcinoma X2",
      sep = "|||"
    ),
    controllevelname = NULL)
)
# if targetlevelname == NULL, the expression set will not be filtered further
# but instead, all samples will be used for calculations
```

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
p_c <- sigident::prognostic_classifier(
  pattern_com = expr_pattern,
  validationstudiesinfo = validationstudiesinfo,
  datadir = datadir,
  idtype = idtype
)
```

### Validation study: GSE30219  

Here we extract information on the study GSE30219.

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
fit <- p_c[["GSE30219"]]$kaplan_estimator$fit
risktable <- p_c[["GSE30219"]]$risktable
```

```{r}
dim(risktable)
head(risktable)
```

#### View proportional hazards regression models

```{r}
p_c[["GSE30219"]]$kaplan_estimator$res_cox
```

```{r}
fit
```


#### Plot prognostic Kaplan-Meier plot

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "GSE30219_Prognostic_Kaplan-Meier_Plot.png")
sigident::plot_survplot(
  fit = fit,
  risktable = risktable,
  filename = filename
)
```

```{r out.width='80%'}
knitr::include_graphics(filename)
```

### Validation study: GSE50081

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
fit <- p_c[["GSE50081"]]$kaplan_estimator$fit
risktable <- p_c[["GSE50081"]]$risktable
```

```{r}
dim(risktable)
head(risktable)
```

#### View proportional hazards regression models

```{r}
p_c[["GSE50081"]]$kaplan_estimator$res_cox
```

```{r}
fit
```

#### Plot prognostic Kaplan-Meier plot

```{r results='hide', message=FALSE, warning=FALSE, error=FALSE}
# create roc plot
filename <- paste0(plotdir, "GSE50081_Prognostic_Kaplan-Meier_Plot.png")
sigident::plot_survplot(
  fit = fit,
  risktable =risktable,
  filename = filename
)
```

```{r out.width='80%'}
knitr::include_graphics(filename)
```

# An alternative workflow: four generic functions for signature identification 

In order to simplify the workflow described above, we wrapped all these functions into four big functions.

## Preprocessing: 

The preprocessing of the data needs to be conform with the above described approach. Here, all necessary objects are created, including `mergeset`, `mergedset`, `batch` and `diagnosis`.

### Define Variables

```{r eval = FALSE}
# initialize filePath:
filePath <- tempdir()
maindir <- "./geodata/"
datadir <- paste0(maindir, "data/")
dir.create(maindir)
dir.create(datadir)

# define more variables
plotdir <- "./plots/"
dir.create(plotdir)
csvdir <- "./csv/"
dir.create(csvdir)

# pathway
species <- "Hs"
OrgDb <- "org.Hs.eg.db"
organism <- "hsa"
pathwayid <- "hsa04151"

# diagnostig signature
seed <- 111
split <- 0.8
nfolds <- 10

# other variables
idtype = "affy"
fdr <- 0.05
```

## Run `sigident.func::sigidentDEG`-function

```{r eval = FALSE}
genes <- sigident.func::sigidentDEG(
  mergeset = mergeset,
  mergedset = mergedset,
  sample_metadata = sample_metadata,
  diagnosis = diagnosis,
  idtype = idtype,
  fdr = fdr,
  plotdir = plotdir,
  csvdir = csvdir
)
```

## Run `sigident.func::sigidentEnrichment`-function

```{r eval = FALSE}
sigident.func::sigidentEnrichment(
  mergeset = mergeset,
  mergedset = mergedset,
  idtype = idtype,
  diagnosis = diagnosis,
  species = species,
  org_db = OrgDb,
  organism = organism,
  pathwayid = pathwayid,
  plotdir = plotdir,
  csvdir = csvdir
)
```
```{r eval = FALSE}
filename <- paste0(plotdir, "/", pathwayid, ".png")
knitr::include_graphics(filename)
```
```{r eval = FALSE}
filename <- paste0(plotdir, "/", pathwayid, ".pathview.png")
knitr::include_graphics(filename)
```

## Run `sigidentDiagnostic`-function 

```{r eval = FALSE}
diagnostic_models <- sigident::sigidentDiagnostic(
  mergeset = mergeset,
  diagnosis = diagnosis,
  seed = seed,
  nfolds = nfolds,
  split = split,
  plotdir = plotdir
)
```

```{r eval = FALSE}
knitr::kable(
  sigident::compare_diagnostic_models(diagnostic_models)
)
```

```{r eval = FALSE}
knitr::kable(
  sigident::get_diagnostic_lambda_values(diagnostic_models)
)
```

### Validation of the diagnostic signatures 

Some users may validate the resulting models using new independent data sets. This can be conducted running the function `validate_diagnostic_signatures`. First, a list containing meta information on the validation study must be created.

```{r eval = FALSE}
validationstudylist <- list(
  "GSE30219" = list(
    setid = 1, 
    targetcolname = "source_name_ch1",
    controllevelname = "Non Tumoral Lung",
    targetlevelname = "Lung Tumour"
  ),
  "GSE33356" = list(
    setid = 1, 
    targetcolname = "characteristics_ch1",
    controllevelname = "tissue: paired normal adjacent",
    targetlevelname = "tissue: lung cancer"
  ),
  "GSE102287" = list(
    setid = 2, 
    targetcolname = "characteristics_ch1.6",
    controllevelname = "tumor_normal status: N",
    targetlevelname = "tumor_normal status: T"
  )
)
```

```{r eval=FALSE}
validation_results <- sigident::validate_diagnostic_signatures(
  validationstudylist = validationstudylist,
  models = diagnostic_models,
  genes = genes,
  idtype = idtype,
  datadir = datadir
)
```

## Run `sigidentPrognostic`-Function 

### First, define meta information lists

```{r eval = FALSE}
validationstudiesinfo <- list(
  "GSE30219" = list(
    setid = 1,
    timecol = "characteristics_ch1.9",
    status = list(
      statuscol = "characteristics_ch1.8",
      levels = list(alive = "status: ALIVE",
                    deceased = "status: DEAD",
                    na = "status: NTL")
    ),
    targetcolname = "source_name_ch1",
    controllevelname = "Non Tumoral Lung",
    targetlevelname = "Lung Tumour"),
  
  "GSE50081" = list(
    setid = 1,
    timecol = "characteristics_ch1.8",
    status = list(
      statuscol = "characteristics_ch1.9",
      levels = list(
        alive = "status: alive",
        deceased = "status: dead",
        na = NA)
    ),
    targetcolname = "characteristics_ch1.1",
    targetlevelname = paste(
      "histology: adenocarcinoma",
      "histology: adenosquamous carcinoma",
      "histology: large cell carcinoma",
      "histology: NSClarge cell carcinoma-mixed",
      "histology: NSCLC-favor adenocarcinoma",
      "histology: squamous cell carcinoma",
      "histology: squamous cell carcinoma X2",
      sep = "|||"
    ),
    controllevelname = NULL)
)
# if targetlevelname == NULL, the expression set will not be filtered further
# but instead, all samples will be used for calculations
```

### Then run the analysis 

```{r eval = FALSE}
progn_results <- sigident::sigidentPrognostic(
  mergeset = mergeset,
  sample_metadata = sample_metadata,
  idtype = idtype,
  genes = genes,
  discoverystudies_w_timedata = discoverystudies_w_timedata,
  classifier_studies = c("GSE18842", "GSE19804"),
  validationstudiesinfo = validationstudiesinfo,
  datadir = datadir,
  plotdir = plotdir,
  csvdir = csvdir
)
```

```{r eval = FALSE}
# create roc plot
filename <- paste0(plotdir, "GSE30219_Prognostic_Kaplan-Meier_Plot.png")
```

```{r eval = FALSE}
knitr::include_graphics(filename)
```

```{r eval = FALSE}
# create roc plot
filename <- paste0(plotdir, "GSE50081_Prognostic_Kaplan-Meier_Plot.png")
```

```{r eval = FALSE}
knitr::include_graphics(filename)
```
